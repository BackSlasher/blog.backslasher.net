<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Backslasher-Python: a simple Chef Python cookbook - BackSlasher</title>
<meta name="description" content="What’s wrong with the current Python cookbook Until now, we were using the Python cookbook. This worked well for a while, until I noticed these things:">


  <meta name="author" content="Nitzan">
  
  <meta property="article:author" content="Nitzan">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="BackSlasher">
<meta property="og:title" content="Backslasher-Python: a simple Chef Python cookbook">
<meta property="og:url" content="https://blog.backslasher.net/backslasher-python.html">


  <meta property="og:description" content="What’s wrong with the current Python cookbook Until now, we were using the Python cookbook. This worked well for a while, until I noticed these things:">







  <meta property="article:published_time" content="2016-02-20T00:00:00+02:00">






<link rel="canonical" href="https://blog.backslasher.net/backslasher-python.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Nitzan",
      "url": "https://blog.backslasher.net/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="BackSlasher Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          BackSlasher
          <span class="site-subtitle">I fix things</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/hireme/">Hire Me</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/nitz.jpg" alt="Nitzan" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Nitzan</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>If this prod is rocking, don’t come a-knocking</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Israel</span>
        </li>
      

      
        
          
            <li><a href="https://backslasher.net" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Backslasher</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Backslasher-Python: a simple Chef Python cookbook">
    <meta itemprop="description" content="What’s wrong with the current Python cookbookUntil now, we were using the Python cookbook. This worked well for a while, until I noticed these things:">
    <meta itemprop="datePublished" content="2016-02-20T00:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Backslasher-Python: a simple Chef Python cookbook
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h3 id="whats-wrong-with-the-current-python-cookbook">What’s wrong with the current Python cookbook</h3>
<p>Until now, we were using the <a href="https://github.com/poise/python">Python cookbook</a>. This worked well for a while, until I noticed these things:</p>

<ol>
  <li>This cookbook is being deprecated, and replaced by <a href="https://github.com/poise/poise-python">poise-python</a>, meaning some day the Python cookbook will be a wrapper around poise-python.</li>
  <li>Even today, when the poise-python cookbook is used in a Chef-run, it’s taking over the Python cookbook’s resources</li>
</ol>

<h3 id="whats-wrong-with-the-poise-python-cookbook">What’s wrong with the Poise-Python cookbook</h3>
<p>This new cookbook is way too magical for me.<br />
I’m not in the habit of criticising other people’s work, and I’m sure CodeRanger knows what he’s doing, but I find the following facts disturbing:</p>

<ol>
  <li>All of the cookbook logic is stored inside <code class="language-plaintext highlighter-rouge">lib/</code>, and processed using <a href="https://github.com/poise/halite">halite</a><br />
 This means the division of recipes/resources/helpers is unclear and you have to “hunt” for the file containing the resource you want to troubleshoot.</li>
  <li>The resources use inheritance for state and logic<br />
 After you found the proper file for your resource, you might need to search other files for methods that are part of the flow you’re troubleshooting.</li>
  <li>Some of the inheritance extends to other cookbooks, like <a href="https://github.com/poise/poise-languages">poise-languages</a> and <a href="https://github.com/poise/poise">poise</a>.<br />
 This is even more annoying because you now have multiple libraries/artifact to troubleshoot (so more lines in your Berksfile, more repos to clone etc), and it’s unclear which logic arives from where.</li>
  <li>
    <p>Some of the methods used are “magical”<br />
 By “magical” I mean methods that aren’t defined in the normal way:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> :::ruby
 def methodname(params)
   # Logic here
 end
</code></pre></div>    </div>

    <p>Instead, they are created by using <a href="http://apidock.com/ruby/Module/define_method">define_method</a> or <a href="http://ruby-doc.org/core-2.1.0/BasicObject.html#method-i-method_missing">method_missing</a>, and can’t be easily found in the files.</p>
  </li>
  <li>
    <p>Some resources automatically backreference other resources.<br />
 I’m talking about this usage pattern:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> :::ruby
 python_runtime '2'

 python_virtualenv '/opt/myapp/.env' # Uses the `python_runtime` defined above automatically
</code></pre></div>    </div>

    <p>This is done by looking at the resource collection and looking for the last item matching some definition (as far as I could understand).<br />
 While this might seem neat, in order for this method to work you have to reorder your code to match the “proper” way. For instance, you can’t separate the runtime and the venv to diffent recipes, because then some other runtime (even from a different cookbook) might be declared and be the one discovered by the virtualenv resource.</p>
  </li>
</ol>

<p>All of these facts, in addition to missing documentation, add up to make the cookbook code really difficult to understand or troubleshoot.<br />
On one hand, the reosurces included in this cookbook should be pretty simple. For instance, the package resource should install a python package (a single command), only if it’s not already installed (another command).<br />
On the other hand, I wrestled with thie Poise-Python cookbook for 3 days and still couldn’t get it to do what the original Python cookbook did. It might be because I have a unique use case (custom-compiled Python), but it’s still furstrating.</p>

<h3 id="enter-backslasher-python-source">Enter <a href="https://supermarket.chef.io/cookbooks/backslasher-python">backslasher-python</a> (<a href="https://github.com/BackSlasher/chef-backslasher-python">source</a>)</h3>
<p>Eventually, I chose to re-implement the Python cookbook by myself.<br />
I made sure to choose a different namespace for the resources (<code class="language-plaintext highlighter-rouge">backslasher_python_*</code>), so it won’t interfere with the existing usage of the Python cookbook (external cookbooks etc).<br />
The new cookbook is written as plainly as possible. <del>Its only vice is using the new custom resource syntax</del> (Edit: Moved back to old syntax. <code class="language-plaintext highlighter-rouge">comapt_resource</code> breaks so easily).</p>

<p>For instance, this is the entire <code class="language-plaintext highlighter-rouge">backslasher_python_virtualenv</code> definition (34 lines of code):</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">property</span> <span class="ss">:path</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">name_attribute: </span><span class="kp">true</span>
<span class="n">property</span> <span class="ss">:interpreter</span><span class="p">,</span> <span class="no">String</span>
<span class="n">property</span> <span class="ss">:owner</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">regex: </span><span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="p">[</span><span class="ss">:user_valid_regex</span><span class="p">]</span>
<span class="n">property</span> <span class="ss">:group</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">regex: </span><span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="p">[</span><span class="ss">:group_valid_regex</span><span class="p">]</span>
<span class="n">property</span> <span class="ss">:options</span><span class="p">,</span> <span class="no">String</span> <span class="c1"># Additional options for venv initialization</span>

<span class="n">default_action</span> <span class="ss">:create</span>

<span class="k">def</span> <span class="nf">exists?</span>
  <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">directory?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">\</span>
    <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/bin/activate"</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:create</span> <span class="k">do</span>
  <span class="n">nr</span> <span class="o">=</span> <span class="nb">self</span> <span class="c1"># me as new_resource</span>
  <span class="n">directory</span> <span class="n">path</span> <span class="k">do</span>
    <span class="n">user</span> <span class="n">nr</span><span class="p">.</span><span class="nf">owner</span> <span class="k">if</span> <span class="n">nr</span><span class="p">.</span><span class="nf">owner</span>
    <span class="n">group</span> <span class="n">nr</span><span class="p">.</span><span class="nf">group</span> <span class="k">if</span> <span class="n">nr</span><span class="p">.</span><span class="nf">group</span>
  <span class="k">end</span>
  <span class="n">execute</span> <span class="s2">"virtualenv </span><span class="si">#{</span><span class="s2">"--python="</span><span class="o">+</span><span class="n">interpreter</span> <span class="k">if</span> <span class="n">interpreter</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">options</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="n">nr</span><span class="p">.</span><span class="nf">owner</span> <span class="k">if</span> <span class="n">nr</span><span class="p">.</span><span class="nf">owner</span>
    <span class="n">group</span> <span class="n">nr</span><span class="p">.</span><span class="nf">group</span> <span class="k">if</span> <span class="n">nr</span><span class="p">.</span><span class="nf">group</span>
    <span class="n">environment</span> <span class="p">({</span> <span class="s1">'HOME'</span> <span class="o">=&gt;</span> <span class="o">::</span><span class="no">Dir</span><span class="p">.</span><span class="nf">home</span><span class="p">(</span><span class="n">nr</span><span class="p">.</span><span class="nf">owner</span><span class="p">)</span> <span class="p">})</span> <span class="k">if</span> <span class="n">nr</span><span class="p">.</span><span class="nf">owner</span>

    <span class="n">not_if</span> <span class="p">{</span><span class="n">nr</span><span class="p">.</span><span class="nf">exists?</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:delete</span> <span class="k">do</span>
  <span class="n">directory</span> <span class="n">path</span> <span class="k">do</span>
    <span class="n">action</span> <span class="ss">:delete</span>
    <span class="n">recursive</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>This code is not dependent on any external code (except for the Chef core logic), and is pretty easy to read.<br />
Compare it to the <a href="https://github.com/poise/poise-python/blob/master/lib/poise_python/resources/python_virtualenv.rb">Poise-Python implementation</a>.</p>

<p>Personally, I’ve successfully replaced the Python cookbook with my Backslasher-Python cookbook in all of my internal uses and consider it a success. I’m curious to see what will happen in public cookbooks.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#chef" class="page__taxonomy-item" rel="tag">Chef</a><span class="sep">, </span>
    
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">Python</a><span class="sep">, </span>
    
      <a href="/tags/#ruby" class="page__taxonomy-item" rel="tag">Ruby</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#foss" class="page__taxonomy-item" rel="tag">FOSS</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2016-02-20T00:00:00+02:00">February 20, 2016</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/chef-custom-resources.html" class="pagination--pager" title="Chef Custom Resources - Missing Documentation
">Previous</a>
    
    
      <a href="/vagrant-external-ruby.html" class="pagination--pager" title="Running external Ruby code from Vagrant
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <!-- start custom comments snippet -->
<div id="graphcomment"></div>
<script type="text/javascript">

  /* - - - CONFIGURATION VARIABLES - - - */

  // make sure the id is yours
  window.gc_params = {
    graphcomment_id: 'Backslasher-net',

    // if your website has a fixed header, indicate it's height in pixels
    fixed_header_height: 0,
  };

  /* - - - DON'T EDIT BELOW THIS LINE - - - */

  
  (function() {
    var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
    gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
  })();

</script>
<!-- end custom comments snippet -->

  
</div>

    
  </article>

  
  
    <div class="page__related">
      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
              style="display:block; border-bottom: initial;"
              data-ad-client="ca-pub-7328585512091257"
              data-ad-slot="3049671934"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
      </div>
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/k3s-gpu.html" rel="permalink">Running GPU workloads on K3S
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A team I work with is very happy with the k8s / ArgoCD setup we set up, and now wants to manage their experimental ML workloads in k8s as well.
These workloa...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/fast-toppings.html" rel="permalink">Getting your toppings fast
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I recently ran into a friend that wanted some help with an app. Because the app is in super secret stealth mode, let’s pretend instead it’s “Pizza Advisor” -...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/postgresql-vector.html" rel="permalink">Semantic caching with PSQL, Python, OpenAI
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">You’re an app developer now
Let’s say you’re working on an app. The app helps you search for e-mail messages that relate to a certain topic. This works well ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/smpp-helper.html" rel="permalink">Java SMPP helper
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">One of my projects involves communicating over SMS with cellular-connected IoT devices. The company already has a working infastructure for sending and recie...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
             style="display:block; border-bottom: initial;"
             data-ad-client="ca-pub-7328585512091257"
             data-ad-slot="3049671934"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Nitzan. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S2WYJL3VQ7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S2WYJL3VQ7', { 'anonymize_ip': true});
</script>






    <!-- start custom comments scripts -->

<!-- end custom comments scripts -->





    <style>
      .google-auto-placed {
        margin: 2em auto;
      }
    </style>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

  </body>
</html>
