<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Getting your toppings fast - BackSlasher</title>
<meta name="description" content="I recently ran into a friend that wanted some help with an app. Because the app is in super secret stealth mode, let’s pretend instead it’s “Pizza Advisor” - an app that uses top of the line Machine Learning to help you plan a great pizza.">


  <meta name="author" content="Nitzan">
  
  <meta property="article:author" content="Nitzan">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="BackSlasher">
<meta property="og:title" content="Getting your toppings fast">
<meta property="og:url" content="https://blog.backslasher.net/fast-toppings.html">


  <meta property="og:description" content="I recently ran into a friend that wanted some help with an app. Because the app is in super secret stealth mode, let’s pretend instead it’s “Pizza Advisor” - an app that uses top of the line Machine Learning to help you plan a great pizza.">



  <meta property="og:image" content="https://blog.backslasher.net/assets/2024-07-11-fast-toppings/header.webp">





  <meta property="article:published_time" content="2024-07-11T00:00:00+03:00">






<link rel="canonical" href="https://blog.backslasher.net/fast-toppings.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Nitzan",
      "url": "https://blog.backslasher.net/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="BackSlasher Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          BackSlasher
          <span class="site-subtitle">I fix things</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/hireme/">Hire Me</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/assets/2024-07-11-fast-toppings/header.webp');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Getting your toppings fast

        
      </h1>
      
      

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/nitz.jpg" alt="Nitzan" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Nitzan</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>If this prod is rocking, don’t come a-knocking</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Israel</span>
        </li>
      

      
        
          
            <li><a href="https://backslasher.net" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Backslasher</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Getting your toppings fast">
    <meta itemprop="description" content="I recently ran into a friend that wanted some help with an app. Because the app is in super secret stealth mode, let’s pretend instead it’s “Pizza Advisor” - an app that uses top of the line Machine Learning to help you plan a great pizza.">
    <meta itemprop="datePublished" content="2024-07-11T00:00:00+03:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <p>I recently ran into a friend that wanted some help with an app. Because the app is in super secret stealth mode, let’s pretend instead it’s “Pizza Advisor” - an app that uses top of the line Machine Learning to help you plan a great pizza.</p>

<h2 id="gotta-go-fast">Gotta go fast</h2>
<p>Said friend is in charge of performance, and they said they want the app “to be fast”. I said that it’s good goal to aspire to, and recommended they start a single core user interaction to monitor and optimize.
They already had one - getting a list of recommended topics, and a metric - “under 1 second”.
I asked them how that’s working out, and to my surprise they showed me something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.5 seconds
2.5 seconds
1.3 seconds
4.0 seconds
...
</code></pre></div></div>
<p>The list was ~50 lines long.</p>

<p>When I inquired, I was told that they had several employees manually running the app and noting down the duration of said interaction.
After asking “why”, they said that since they have no users, they had to measure the app somehow.<br />
I knew we had to automate.</p>

<h2 id="enter-pizza-boy">Enter Pizza Boy</h2>
<p>We quickly created “Pizza Boy”: a lightweight, system-agnostic, highly flexible scheduled synthetic transaction generator. Here it is:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while </span><span class="nb">sleep </span>1m<span class="p">;</span> <span class="k">do
  </span>curl <span class="nt">-o</span> /dev/null <span class="nt">-s</span> <span class="se">\</span>
  <span class="nt">-w</span> <span class="s1">'Connection: %{time_connect}s\nTTFB: %{time_starttransfer}s\nTotal: %{time_total}s\n'</span> <span class="se">\</span>
  <span class="s1">'https://pizza-advisor.com/v1/toppings?crust=thin&amp;cheese=yes'</span>
<span class="k">done</span>
</code></pre></div></div>

<p>We started running it on my laptop and got a list of these:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Connection: 0.029364s
TTFB: 2.518121s
Total: 2.531129s
...
</code></pre></div></div>

<p>Something interesting we noted is that almost all of the time was spent on the server side. This meant that we can drop the differention between the performance metrics on the client side, and assume that total duration == server processing time.</p>

<h2 id="grown-into-pizza-person">Grown into Pizza Person</h2>
<p>Now that we freed those employees from running the app over and over, we had time to improve Pizza Boy into more than a simple Bash script. We rewrote it in Python, gave it its own server to run in, and started reporting the results to Prometheus, like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">make_wsgi_app</span><span class="p">,</span> <span class="n">Histogram</span>
<span class="n">impnveort</span> <span class="n">time</span>
<span class="p">...</span>
<span class="n">REQUEST_TIME</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s">'request_time'</span>
    <span class="s">'time for entire request'</span>
<span class="p">)</span>
<span class="p">...</span>
<span class="k">def</span> <span class="nf">measure</span><span class="p">():</span>
  <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">get_toppings</span><span class="p">()</span>
  <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">REQUEST_TIME</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

<span class="p">...</span>
</code></pre></div></div>
<p>Using Grafana, we built a nice graph out of the data reported to Prometheus so pepole can track it
<img src="/assets/2024-07-11-fast-toppings/latency.png" alt="" /></p>

<h2 id="why-so-slow">Why so slow?</h2>
<p>Once we had a good handle on how long this interaction takes, we got into whiteboxing the server side and understanding where the time was spent.<br />
I won’t go deep into the server optimization, as it’s highly specific and not very interesting. The graph looked sort of like this:
<img src="/assets/2024-07-11-fast-toppings/monitoring.png" alt="" /></p>

<p>We iterated on improving the server’s bottlenecks until Grafana confirmed we reached satisfactory response times.</p>

<h2 id="real-users--fake-users">Real users &gt; Fake users</h2>
<p>During the rollout of “Pizza Advisor” to real users, we did two things:</p>

<ol>
  <li>Fed the graph with response times from humans using the actual app</li>
  <li>Decommisioned Pizza Person</li>
</ol>

<p>While it’s obvious that collecting data from humans is better, I got a bit of pushback on decomissioning Pizza Person. It’s working well, why kill it?<br />
My reasoning was that synthetic transactions are ineherntly inferior to real ones. Right now Pizza Person’s behavior might be similar enough to the real app, but the app might get updated (different parameters, compression, HTTP keepalives), making Pizza Person more and more out of sync and turning its data into harmful noise. Once we have enough data from real users, there’s no point in taking that risk.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#monitoring" class="page__taxonomy-item" rel="tag">Monitoring</a><span class="sep">, </span>
    
      <a href="/tags/#rambling" class="page__taxonomy-item" rel="tag">Rambling</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2024-07-11T00:00:00+03:00">July 11, 2024</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/postgresql-vector.html" class="pagination--pager" title="Semantic caching with PSQL, Python, OpenAI
">Previous</a>
    
    
      <a href="/k3s-gpu.html" class="pagination--pager" title="Running GPU workloads on K3S
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <!-- start custom comments snippet -->
<div id="graphcomment"></div>
<script type="text/javascript">

  /* - - - CONFIGURATION VARIABLES - - - */

  // make sure the id is yours
  window.gc_params = {
    graphcomment_id: 'Backslasher-net',

    // if your website has a fixed header, indicate it's height in pixels
    fixed_header_height: 0,
  };

  /* - - - DON'T EDIT BELOW THIS LINE - - - */

  
  (function() {
    var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
    gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
  })();

</script>
<!-- end custom comments snippet -->

  
</div>

    
  </article>

  
  
    <div class="page__related">
      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
              style="display:block; border-bottom: initial;"
              data-ad-client="ca-pub-7328585512091257"
              data-ad-slot="3049671934"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
      </div>
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/django-db-images.html" rel="permalink">Serving Images from the DB in Django
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I recently got to work on prototyping a small Django-based website that was somewhat like a message board.
One of the features requested was allowing users t...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/k3s-gpu.html" rel="permalink">Running GPU workloads on K3S
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A team I work with is very happy with the k8s / ArgoCD setup we set up, and now wants to manage their experimental ML workloads in k8s as well.
These workloa...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/postgresql-vector.html" rel="permalink">Semantic caching with PSQL, Python, OpenAI
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">You’re an app developer now
Let’s say you’re working on an app. The app helps you search for e-mail messages that relate to a certain topic. This works well ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/smpp-helper.html" rel="permalink">Java SMPP helper
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">One of my projects involves communicating over SMS with cellular-connected IoT devices. The company already has a working infastructure for sending and recie...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
             style="display:block; border-bottom: initial;"
             data-ad-client="ca-pub-7328585512091257"
             data-ad-slot="3049671934"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Nitzan. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S2WYJL3VQ7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S2WYJL3VQ7', { 'anonymize_ip': true});
</script>






    <!-- start custom comments scripts -->

<!-- end custom comments scripts -->





    <style>
      .google-auto-placed {
        margin: 2em auto;
      }
    </style>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

  </body>
</html>
