<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>SPNs - Who? Why? Where? - BackSlasher</title>
<meta name="description" content="I was making an introduction to a new teammate about SharePoint infrastructure, and one of the things I had to teach her about was SPNs. I was surprised to know almost no one at our place knew what SPNs are actually for. Until my PowerPoint presentation is ready, here is a (relatively) short explanation: First of all, SPNs are part of how Kerberos authentication works, and is used to help encrypt the Client-Server ticket. This a very basic explanation of what’s going on:">


  <meta name="author" content="Nitzan">
  
  <meta property="article:author" content="Nitzan">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="BackSlasher">
<meta property="og:title" content="SPNs - Who? Why? Where?">
<meta property="og:url" content="https://blog.backslasher.net/spns-who-why-where.html">


  <meta property="og:description" content="I was making an introduction to a new teammate about SharePoint infrastructure, and one of the things I had to teach her about was SPNs. I was surprised to know almost no one at our place knew what SPNs are actually for. Until my PowerPoint presentation is ready, here is a (relatively) short explanation: First of all, SPNs are part of how Kerberos authentication works, and is used to help encrypt the Client-Server ticket. This a very basic explanation of what’s going on:">







  <meta property="article:published_time" content="2010-10-02T00:00:00+02:00">






<link rel="canonical" href="https://blog.backslasher.net/spns-who-why-where.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Nitzan",
      "url": "https://blog.backslasher.net/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="BackSlasher Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          BackSlasher
          <span class="site-subtitle">I fix things</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/hireme/">Hire Me</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/nitz.jpg" alt="Nitzan" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Nitzan</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>If this prod is rocking, don’t come a-knocking</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Israel</span>
        </li>
      

      
        
          
            <li><a href="https://backslasher.net" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Backslasher</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="SPNs - Who? Why? Where?">
    <meta itemprop="description" content="I was making an introduction to a new teammate about SharePointinfrastructure, and one of the things I had to teach her about was SPNs.I was surprised to know almost no one at our place knew what SPNs areactually for. Until my PowerPoint presentation is ready, here is a(relatively) short explanation:First of all, SPNs are part of how Kerberos authentication works, and isused to help encrypt the Client-Server ticket. This a very basicexplanation of what’s going on:">
    <meta itemprop="datePublished" content="2010-10-02T00:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">SPNs - Who? Why? Where?
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I was making an introduction to a new teammate about SharePoint
infrastructure, and one of the things I had to teach her about was SPNs.
I was surprised to know almost no one at our place knew what SPNs are
actually for. Until my PowerPoint presentation is ready, here is a
(relatively) short explanation:<br />
First of all, SPNs are part of how Kerberos authentication works, and is
used to help encrypt the Client-Server ticket. This a <strong>very</strong> basic
explanation of what’s going on:</p>

<ol>
  <li>When the user logs in to an Active Directory domain, it recives a
TGT (ticket-granting ticket), allowing the client to request other
tickets. It’s only capable of proving the client’s identity to a DC.</li>
  <li>Whenever the client decides to authenticate to a service (for
example, a web site), the client requests its DC for a CS
(client-server) ticket, providing the TGT as proof of its identity.</li>
  <li>The DC replies with a CS ticket, <strong>encrypted so that only the
service can read it</strong>. This ticket proves to this specific service
that the ticket’s holder is a specific client</li>
  <li>The client passes the CS ticket on (note it can’t read it itself) to
the service.</li>
  <li>The service decrypts the CS ticket, and therefore validates that the
CS ticket-holder is in fact the user as claimed.</li>
</ol>

<p>The SPN comes in step 3 (if you haven’t guessed), to help the DC decide
how to encrypt the CS ticket. Understandably, the only thing that only
the DC and the service know (the <strong>shared secret</strong>) is the service
user’s (the user running the service) password, or any hash derived from
it. So the DC encrypts the CS ticket with a hash of the service user’s
password, and sends the ticket onwards.<br />
Let’s look at an example:<br />
The user <code class="language-plaintext highlighter-rouge">Dom\Nitz</code> tries to connect to server <code class="language-plaintext highlighter-rouge">Dom\Server</code> in port
<code class="language-plaintext highlighter-rouge">81</code>:</p>

<ol>
  <li>Nitz logs on to the domain and gets a TGT for <code class="language-plaintext highlighter-rouge">Dom\Nitz</code>.</li>
  <li>Nitz opens his Internet Explorer and connects to
<code class="language-plaintext highlighter-rouge">http://Server:81</code>.<br />
   The IE and the IIS on the other side negotiate Kerberos
authentication.<br />
   IE requests from the DC (through windows, of course) a CS ticket for
the <strong>service</strong> <code class="language-plaintext highlighter-rouge">http/Server:81</code> (notice the SPN shape)</li>
  <li>The DC creates the CS ticket and encrypts it with the service’s
password.<br />
   <strong>Whose password should it use?</strong></li>
</ol>

<p>If no SPN is specified, the DC assumes the service user is the server’s
account, in our case <code class="language-plaintext highlighter-rouge">Dom\Server$,</code> and uses its password (yes,
computer accounts have passwords). Let’s see what happens if the DC is
right:</p>

<ol>
  <li>The Client receives the CS ticket, and passes it on to the service
on port 81.</li>
  <li>The web server (running as <code class="language-plaintext highlighter-rouge">Dom\Server$</code>) decrypts the ticket and
validates the client’s identity. Success!</li>
</ol>

<p>The problem starts when this assumption is wrong. For example, when the
server is part of a SharePoint farm and port 81 is run from an appPool with
user <code class="language-plaintext highlighter-rouge">Dom\Service</code>. Let’s see what happens then:</p>

<ol>
  <li>The Client receives the CS ticket, and passes it on to the service
on port 81.</li>
  <li>The web server (running as <code class="language-plaintext highlighter-rouge">Dom\Service</code>) <strong>tries</strong> to decrypt the
ticket, and fails (since its password wasn’t the one used to encrypt
it).<br />
   Kerberos Authentication Error, type <code class="language-plaintext highlighter-rouge">KRB_AP_ERR_MODIFIED</code>. :-(</li>
</ol>

<p>The SPN, as you must have guessed, is a way to tell the DC something
like “encrypt all CS tickets for <code class="language-plaintext highlighter-rouge">http/Server:81</code> using <code class="language-plaintext highlighter-rouge">Dom\Service</code>’s
password”. That way, CS tickets forwarded to this service will decrypt
correctly. It’s done by adding the <strong>Service Principle Name</strong> (or “the
way the service is called”), composed of <code class="language-plaintext highlighter-rouge">Protocol/ServerName[:Port]</code>
(only specify port for non-defaults, like HTTP ports other than 80) to
the attribute on the service account in the Active Directory.</p>

<h3 id="what-do-i-do">What do I do?</h3>
<h4 id="the-short-answer">The short answer</h4>
<p>If you have a service not running as <code class="language-plaintext highlighter-rouge">SYSTEM</code>, but rather as a domain account, you have to use an SPN to allow kerberos authentication to it. Add the right SPN (such as <code class="language-plaintext highlighter-rouge">http/Server:81</code>) to the domain account
running the service. That’s it. No restart, no logoff, nothing.</p>
<h4 id="details">Details</h4>
<p>You can either use <code class="language-plaintext highlighter-rouge">adsiedit</code> (BE CAREFUL!) to write to <code class="language-plaintext highlighter-rouge">ServicePrincipalName</code> of the right domain account, or use <code class="language-plaintext highlighter-rouge">SetSpn {SPN} {Domain\\Account}</code></p>

<h4 id="protips">Protips</h4>
<ul>
  <li>Always register short (NETBIOS) server name (<code class="language-plaintext highlighter-rouge">Server</code>) and long (DNS) server name (<code class="language-plaintext highlighter-rouge">Server.Domain.Com</code>), to avoid glitches in authentication mechanizes and human errors.</li>
  <li>Consider cleanups of decommissioned services (see <code class="language-plaintext highlighter-rouge">SetSpn</code> on server 2008+) to avoid duplicate SPNs (same SPN entry, two or more different users). Duplicate SPNs are bad, because the DC doesn’t know who’s password to use to encrypt the CS
ticket.</li>
  <li>If you’re having Kerberos authentication issues, try
<a href="http://technet.microsoft.com/en-us/library/cc728430%28WS.10%29.aspx">troubleshooting</a> before giving up and falling back to NTLM for good. Kerberos isn’t that
complex to set up! (Only to troubleshoot…).</li>
</ul>

<h4 id="pitfalls">Pitfalls:</h4>
<ul>
  <li>Service account is:
    <ul>
      <li>Locked out</li>
      <li>Has different password than in AD (did you change the password?)</li>
      <li>Lost <code class="language-plaintext highlighter-rouge">User Right Assignments</code> on the server (faulty Group Policy)</li>
    </ul>
  </li>
  <li>User account is:
    <ul>
      <li>Locked out</li>
      <li>Has different password than in AD (“Windows needs your current credentials” is usually that)</li>
    </ul>
  </li>
  <li>Machines are:
    <ul>
      <li>With a firewall blocking necessary AD ports (to their respective DCs)</li>
      <li>With a time difference greater than the Kerb tolerance policy (usually 5
  mins)</li>
      <li>AD membership is messed up (use <code class="language-plaintext highlighter-rouge">NETDOM VERIFY</code>)</li>
    </ul>
  </li>
  <li>Kerberos almost certainly won’t work for
    <ul>
      <li>Computers set in different domains without trusts (ask the AD admins)</li>
      <li>Computers outside a domain (duh)</li>
      <li>Services addressed using IP (i.e. <code class="language-plaintext highlighter-rouge">http://127.0.0.1/</code>)</li>
    </ul>
  </li>
</ul>

<h3 id="summary">Summary</h3>
<p>Kerberos is a great auth mechanism
for windows-based services, and especially SharePoint (very little farm
config needed). SPNs are required if a non-SYSTEM user is used, or a
multi-FE farm is deployed (and you choose Kerberos).<br />
It’s easy to deploy Kerberos auth (after making all possible mistakes), just make sure you’re coupled with an AD guy to avoid stupid issues (like replication / incorrect account selection), and most importantly, DON’T PANIC!<br />
I hope this post will save at least one person a night of frustration, learning how to deploy SPNs the hard way.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#active-directory" class="page__taxonomy-item" rel="tag">Active Directory</a><span class="sep">, </span>
    
      <a href="/tags/#kerberos" class="page__taxonomy-item" rel="tag">Kerberos</a><span class="sep">, </span>
    
      <a href="/tags/#security" class="page__taxonomy-item" rel="tag">Security</a><span class="sep">, </span>
    
      <a href="/tags/#sharepoint" class="page__taxonomy-item" rel="tag">SharePoint</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#microsoft" class="page__taxonomy-item" rel="tag">Microsoft</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2010-10-02T00:00:00+02:00">October 2, 2010</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/2008-clusters-cant-change-password.html" class="pagination--pager" title="2008 Clusters can’t change password
">Previous</a>
    
    
      <a href="/few-seconds-about-psbase.html" class="pagination--pager" title="A few seconds about psbase
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <!-- start custom comments snippet -->
<div id="graphcomment"></div>
<script type="text/javascript">

  /* - - - CONFIGURATION VARIABLES - - - */

  // make sure the id is yours
  window.gc_params = {
    graphcomment_id: 'Backslasher-net',

    // if your website has a fixed header, indicate it's height in pixels
    fixed_header_height: 0,
  };

  /* - - - DON'T EDIT BELOW THIS LINE - - - */

  
  (function() {
    var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
    gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
  })();

</script>
<!-- end custom comments snippet -->

  
</div>

    
  </article>

  
  
    <div class="page__related">
      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
              style="display:block; border-bottom: initial;"
              data-ad-client="ca-pub-7328585512091257"
              data-ad-slot="3049671934"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
      </div>
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/openwrt-switcher.html" rel="permalink">Bridging Switcher’s UDP over OpenWRT
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Seems like I’m doing this setup once every 3 years, then forget about it until the next time it breaks.
I hope this is the last time I’m rediscovering this.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/invalid-number-nov.html" rel="permalink">Invalid number: Nov
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">One of my current projects is migrating a big Java project from Java 8 to a supported version. Since we’re doing small, stable steps, we started with Java 11...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/no-dst.html" rel="permalink">We don’t do DST at this company
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Once, a long time ago, I used to have a consulting gig in some big enterprise-y company. It had a lot of unique challenges, being disconnected from the inter...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/jar-patch.html" rel="permalink">Patching a Java JAR
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I’m working with a company that uses smart IoT devices produced far away.
The main troubleshooting tool is a Java utility provided by the manufacturer.
This ...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

      <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
             style="display:block; border-bottom: initial;"
             data-ad-client="ca-pub-7328585512091257"
             data-ad-slot="3049671934"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Nitzan. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S2WYJL3VQ7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S2WYJL3VQ7', { 'anonymize_ip': true});
</script>






    <!-- start custom comments scripts -->

<!-- end custom comments scripts -->





    <style>
      .google-auto-placed {
        margin: 2em auto;
      }
    </style>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

  </body>
</html>
